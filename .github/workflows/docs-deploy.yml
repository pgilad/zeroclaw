name: Docs Deploy

on:
    pull_request:
        branches: [dev, main]
        paths:
            - "docs/**"
            - "README*.md"
            - ".github/workflows/docs-deploy.yml"
            - "scripts/ci/docs_quality_gate.sh"
            - "scripts/ci/collect_changed_links.py"
    push:
        branches: [dev, main]
        paths:
            - "docs/**"
            - "README*.md"
            - ".github/workflows/docs-deploy.yml"
            - "scripts/ci/docs_quality_gate.sh"
            - "scripts/ci/collect_changed_links.py"
    workflow_dispatch:
        inputs:
            deploy_target:
                description: "preview uploads artifact only; production deploys to Pages"
                required: true
                default: preview
                type: choice
                options:
                    - preview
                    - production

concurrency:
    group: docs-deploy-${{ github.event.pull_request.number || github.sha }}
    cancel-in-progress: true

permissions:
    contents: read

jobs:
    docs-quality:
        name: Docs Quality Gate
        runs-on: blacksmith-2vcpu-ubuntu-2404
        timeout-minutes: 20
        outputs:
            docs_files: ${{ steps.scope.outputs.docs_files }}
            base_sha: ${{ steps.scope.outputs.base_sha }}
        steps:
            - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
              with:
                  fetch-depth: 0

            - name: Resolve docs diff scope
              id: scope
              shell: bash
              run: |
                  set -euo pipefail

                  base_sha=""
                  docs_files=""

                  if [ "${GITHUB_EVENT_NAME}" = "pull_request" ]; then
                    base_sha="${{ github.event.pull_request.base.sha }}"
                    docs_files="$(git diff --name-only "$base_sha" HEAD | awk '/\.md$|\.mdx$|^README/ {print}')"
                  elif [ "${GITHUB_EVENT_NAME}" = "push" ]; then
                    base_sha="${{ github.event.before }}"
                    if [ -n "$base_sha" ] && [ "$base_sha" != "0000000000000000000000000000000000000000" ]; then
                      docs_files="$(git diff --name-only "$base_sha" HEAD | awk '/\.md$|\.mdx$|^README/ {print}')"
                    fi
                  else
                    docs_files="$(git ls-files 'docs/**/*.md' 'README*.md')"
                  fi

                  {
                    echo "base_sha=${base_sha}"
                    echo "docs_files<<EOF"
                    printf '%s\n' "$docs_files"
                    echo "EOF"
                  } >> "$GITHUB_OUTPUT"

            - name: Markdown quality gate
              env:
                  BASE_SHA: ${{ steps.scope.outputs.base_sha }}
                  DOCS_FILES: ${{ steps.scope.outputs.docs_files }}
              run: ./scripts/ci/docs_quality_gate.sh

            - name: Collect added links
              id: links
              if: github.event_name != 'workflow_dispatch'
              shell: bash
              env:
                  BASE_SHA: ${{ steps.scope.outputs.base_sha }}
                  DOCS_FILES: ${{ steps.scope.outputs.docs_files }}
              run: |
                  set -euo pipefail
                  python3 ./scripts/ci/collect_changed_links.py \
                    --base "$BASE_SHA" \
                    --docs-files "$DOCS_FILES" \
                    --output .ci-added-links.txt
                  count=$(wc -l < .ci-added-links.txt | tr -d ' ')
                  echo "count=$count" >> "$GITHUB_OUTPUT"

            - name: Link check (added links)
              if: github.event_name != 'workflow_dispatch' && steps.links.outputs.count != '0'
              uses: lycheeverse/lychee-action@a8c4c7cb88f0c7386610c35eb25108e448569cb0 # v2
              with:
                  fail: true
                  args: >-
                      --offline
                      --no-progress
                      --format detailed
                      .ci-added-links.txt
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Skip link check (none added)
              if: github.event_name != 'workflow_dispatch' && steps.links.outputs.count == '0'
              run: echo "No added links detected in changed docs lines."

    docs-preview:
        name: Docs Preview Artifact
        needs: [docs-quality]
        if: github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_target == 'preview')
        runs-on: blacksmith-2vcpu-ubuntu-2404
        timeout-minutes: 15
        steps:
            - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

            - name: Build preview bundle
              shell: bash
              run: |
                  set -euo pipefail
                  rm -rf site
                  mkdir -p site/docs
                  cp -R docs/. site/docs/
                  cp README.md site/README.md
                  cat > site/index.md <<'EOF'
                  # ZeroClaw Docs Preview

                  This preview bundle is produced by `.github/workflows/docs-deploy.yml`.

                  - [Repository README](./README.md)
                  - [Docs Home](./docs/README.md)
                  EOF

            - name: Upload preview artifact
              uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
              with:
                  name: docs-preview
                  path: site/**
                  if-no-files-found: error
                  retention-days: 14

    docs-deploy:
        name: Deploy Docs to GitHub Pages
        needs: [docs-quality]
        if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_target == 'production')
        runs-on: blacksmith-2vcpu-ubuntu-2404
        timeout-minutes: 20
        permissions:
            contents: read
            pages: write
            id-token: write
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}
        steps:
            - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

            - name: Build deploy bundle
              shell: bash
              run: |
                  set -euo pipefail
                  rm -rf site
                  mkdir -p site/docs
                  cp -R docs/. site/docs/
                  cp README.md site/README.md
                  cat > site/index.md <<'EOF'
                  # ZeroClaw Documentation

                  This site is deployed automatically from `main` by `.github/workflows/docs-deploy.yml`.

                  - [Repository README](./README.md)
                  - [Docs Home](./docs/README.md)
                  EOF

            - name: Setup Pages
              uses: actions/configure-pages@983d7736d9b0ae728b81ab479565c72886d7745b # v5

            - name: Upload Pages artifact
              uses: actions/upload-pages-artifact@7b1f4a764d45c48632c6b24a0339c27f5614fb0b # v4
              with:
                  path: site

            - name: Deploy to GitHub Pages
              id: deployment
              uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4
